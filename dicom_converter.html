<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>Interactive MRI Viewer | Remy Cohan</title>

  <style>
    body, html {
      margin: 0;
      padding: 0;
      width: 100%;
      height: 100%;
      font-family: sans-serif;
      background-color: #222;
      color: #fff;
      overflow: hidden; /* No scrollbars */
    }

    /* Layout */
    .app-container {
      display: flex;
      height: 100vh;
      width: 100vw;
    }

    /* Sidebar */
    .sidebar {
      width: 320px;
      background: #ffffff;
      color: #333;
      padding: 20px;
      display: flex;
      flex-direction: column;
      border-right: 1px solid #444;
      z-index: 100; /* Ensure sidebar is above */
    }

    /* Viewer Area */
    .content {
      flex-grow: 1;
      position: relative;
      background-color: #000;
    }

    /* The Canvas where the brain goes */
    canvas#gl {
      width: 100%;
      height: 100%;
      display: block;
    }

    /* Status Indicator */
    #status {
      padding: 10px;
      margin-bottom: 10px;
      border-radius: 4px;
      font-weight: bold;
      text-align: center;
    }
    .status-bad { background: #ffcccc; color: #cc0000; }
    .status-good { background: #ccffcc; color: #006600; }

    h3 { margin-top: 0; }
  </style>
</head>
<body>

<div class="app-container">
  <div class="sidebar">
    <div id="status" class="status-bad">LOADING NIIVUE...</div>

    <h3>MRI Viewer</h3>
    <p><strong>Instructions:</strong></p>
    <ol>
      <li>Wait for the status above to turn GREEN.</li>
      <li>Drag and drop your <code>.nii.gz</code> file onto the <strong>BLACK AREA</strong> on the right.</li>
    </ol>
    <p><em>If the screen goes white/blank when you drop, refresh and ensure you drop exactly on the black area.</em></p>

    <div style="margin-top:20px; border-top:1px solid #eee; padding-top:20px;">
      <label><input type="checkbox" id="check3D" checked onchange="updateView()"> Enable 3D Render</label>
    </div>

    <p style="margin-top:auto; font-size:0.8rem; color:#888;">Powered by NiiVue</p>
  </div>

  <div class="content">
    <canvas id="gl"></canvas>
  </div>
</div>

<script src="https://unpkg.com/@niivue/niivue@0.41.0/dist/niivue.umd.js"></script>

<script>
  const statusDiv = document.getElementById('status');
  var nv; // Global variable for the viewer

  // --- SAFEGUARD 1: Check if Library Loaded ---
  if (typeof niivue === 'undefined') {
    statusDiv.innerHTML = "❌ ERROR: NiiVue failed to load.<br>Check internet connection.";
  } else {
    initViewer();
  }

  function initViewer() {
    try {
      // Initialize NiiVue
      nv = new niivue.Niivue({
        dragAndDropEnabled: false, // We will handle drag/drop manually to prevent bugs
        backColor: [0, 0, 0, 1],
        show3Dcrosshair: true,
      });

      nv.attachTo('gl');
      
      // Set default view to 4-pane
      nv.setSliceType(nv.sliceTypeMultiplanar);

      // Try to load default image (optional, might fail locally)
      // nv.loadVolumes([{ url: "images/mni152.nii.gz" }]);

      statusDiv.className = "status-good";
      statusDiv.innerHTML = "✅ SYSTEM READY<br>Drop file on Black Area";

    } catch (e) {
      statusDiv.className = "status-bad";
      statusDiv.innerHTML = "❌ Error initializing: " + e.message;
    }
  }

  // --- SAFEGUARD 2: Global Drag/Drop Handler ---
  // This stops the "Blank Chrome Window" issue by killing the browser's default reaction
  
  window.addEventListener("dragover", function(e) {
    e.preventDefault(); // Stop browser from previewing the file
    e.stopPropagation();
  }, false);

  window.addEventListener("drop", function(e) {
    e.preventDefault(); // Stop browser from downloading the file
    e.stopPropagation();

    // Get the file
    if (e.dataTransfer && e.dataTransfer.files && e.dataTransfer.files.length > 0) {
      const file = e.dataTransfer.files[0];
      
      // Pass it to NiiVue manually
      // We wrap it in an array because that's what loadFromFile expects
      if (nv) {
        nv.loadVolumes([{ file: file }]);
        statusDiv.innerHTML = "✅ Loading file: " + file.name;
      }
    }
  }, false);

  // View Toggle
  function updateView() {
    if(!nv) return;
    if (document.getElementById('check3D').checked) {
      nv.setSliceType(nv.sliceTypeMultiplanar);
    } else {
      nv.setSliceType(nv.sliceTypeAxial);
    }
  }
</script>

</body>
</html>
