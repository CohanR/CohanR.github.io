<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <title>NiiVue Pro (Fixed 0.57.0)</title>
  
  <style>
    body { margin: 0; font-family: sans-serif; height: 100vh; display: flex; flex-direction: column; background: #000; color: #fff; overflow: hidden; }
    
    /* MENU BAR */
    header { background: #333; height: 40px; display: flex; align-items: center; padding: 0 10px; user-select: none; }
    
    .dropdown { position: relative; display: inline-block; }
    .dropbtn { background: transparent; color: white; padding: 10px 15px; font-size: 14px; border: none; cursor: pointer; }
    .dropdown:hover .dropbtn { background-color: #555; }
    
    .dropdown-content {
      display: none; position: absolute; background-color: #222; min-width: 160px;
      box-shadow: 0 8px 16px rgba(0,0,0,0.5); z-index: 100; border: 1px solid #444; top: 40px;
    }
    .dropdown-content a { color: #ccc; padding: 12px 16px; text-decoration: none; display: block; font-size: 13px; cursor: pointer; }
    .dropdown-content a:hover { background-color: #007bff; color: white; }
    .dropdown:hover .dropdown-content { display: block; }
    
    .divider { border-top: 1px solid #444; margin-top: 4px; padding-top: 4px; }

    /* LAYOUT */
    main { flex: 1; position: relative; width: 100%; height: 100%; }
    canvas { width: 100%; height: 100%; display: block; outline: none; }
    footer { background: #222; font-size: 12px; color: #888; padding: 5px 10px; border-top: 1px solid #444; }

    /* OVERLAY */
    #overlay {
      position: absolute; top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(0,0,0,0.85); display: flex; justify-content: center; align-items: center;
      z-index: 50; pointer-events: none; opacity: 0; transition: opacity 0.2s;
    }
    #overlay.active { opacity: 1; pointer-events: auto; }
    .msg-box { border: 2px dashed #666; padding: 40px; border-radius: 10px; background: #151515; text-align: center; }
  </style>
</head>
<body>

  <header>
    <div class="dropdown">
      <button class="dropbtn">File â–¼</button>
      <div class="dropdown-content">
        <a onclick="openFile()">ðŸ“‚ Open Folder/Files...</a>
        <a onclick="saveScreenshot()">ðŸ“· Screenshot</a>
      </div>
    </div>
    <div class="dropdown">
      <button class="dropbtn">View â–¼</button>
      <div class="dropdown-content">
        <a onclick="setSlice('multi')">Multi-Planar (A+C+S+R)</a>
        <a class="divider"></a>
        <a onclick="setSlice('axial')">Axial</a>
        <a onclick="setSlice('coronal')">Coronal</a>
        <a onclick="setSlice('sagittal')">Sagittal</a>
        <a onclick="setSlice('render')">3D Render</a>
        <a class="divider"></a>
        <a onclick="toggleCrosshair()">Toggle Crosshair</a>
        <a onclick="toggleRadiological()">Toggle Radiological</a>
      </div>
    </div>
    <div class="dropdown">
      <button class="dropbtn">Color â–¼</button>
      <div class="dropdown-content">
        <a onclick="setColor('gray')">Gray</a>
        <a onclick="setColor('plasma')">Plasma</a>
        <a onclick="setColor('viridis')">Viridis</a>
        <a onclick="setColor('inferno')">Inferno</a>
        <a onclick="setColor('bone')">Bone</a>
      </div>
    </div>
  </header>

  <main>
    <div id="overlay">
      <div class="msg-box">
        <h2>Drag Files Here</h2>
        <p style="font-size:12px; color:#999">Supports NIfTI and single DICOMs</p>
        <input type="file" id="fileInput" multiple style="display:none">
        <button onclick="document.getElementById('fileInput').click()" style="padding:10px 20px; cursor:pointer;">Browse Files</button>
      </div>
    </div>
    <canvas id="gl"></canvas>
  </main>

  <footer id="intensity">Ready.</footer>

  <script type="module" async>
    import { Niivue } from "https://unpkg.com/@niivue/niivue@0.57.0/dist/index.js";

    const statusEl = document.getElementById("intensity");
    const overlay = document.getElementById("overlay");
    
    // Initialize
    const nv = new Niivue({
      dragAndDropEnabled: true, // We allow NiiVue's internal handler to work
      onLocationChange: (data) => { statusEl.innerHTML = data.string; }
    });
    
    await nv.attachTo("gl");
    
    // Set Defaults
    nv.setSliceType(nv.sliceTypeMultiplanar);
    nv.opts.multiplanarForceRender = true;
    nv.setMeshProperty(0, {rgba255: [0, 0, 0, 255]});
    
    // Show overlay initially
    overlay.classList.add('active');

    // --- EXPOSE FUNCTIONS (UI) ---
    window.setSlice = (type) => {
        if(type === 'multi') {
            nv.opts.multiplanarShowRender = true;
            nv.setSliceType(nv.sliceTypeMultiplanar);
        }
        else if(type === 'axial') nv.setSliceType(nv.sliceTypeAxial);
        else if(type === 'coronal') nv.setSliceType(nv.sliceTypeCoronal);
        else if(type === 'sagittal') nv.setSliceType(nv.sliceTypeSagittal);
        else if(type === 'render') nv.setSliceType(nv.sliceTypeRender);
    };

    window.setColor = (name) => {
        if(nv.volumes.length) { 
            nv.volumes[0].colormap = name; 
            nv.updateGLVolume(); 
        }
    };

    window.saveScreenshot = () => nv.saveScene("screen.png");
    
    window.toggleCrosshair = () => {
        nv.opts.show3Dcrosshair = !nv.opts.show3Dcrosshair;
        nv.drawScene();
    };

    window.toggleRadiological = () => {
        nv.opts.isRadiologicalConvention = !nv.opts.isRadiologicalConvention;
        nv.drawScene();
    };

    window.openFile = () => document.getElementById('fileInput').click();

    // --- DRAG & DROP UI HIDING ---
    // We let NiiVue handle the actual loading, we just hide the overlay when something is dropped
    document.body.addEventListener('drop', (e) => {
        overlay.classList.remove('active');
        statusEl.innerText = "Loading dropped files...";
    });

    // --- FILE INPUT HANDLING (FIXED) ---
    document.getElementById('fileInput').onchange = async (e) => {
        const files = e.target.files;
        if (files.length === 0) return;
        
        overlay.classList.remove('active');
        statusEl.innerText = `Loading ${files.length} files...`;
        
        try {
            // FIX: Using loadFromFile (singular) in a loop because loadFromFiles is gone in 0.57.0
            for (const file of files) {
                if(file.name.startsWith('.')) continue; // skip hidden files
                await nv.loadFromFile(file); 
            }
            statusEl.innerText = "Loaded.";
        } catch (err) {
            statusEl.innerText = "Error: " + err.message;
            console.error(err);
        }
    };
  </script>
</body>
</html>
