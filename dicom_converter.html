<!-- dicom_converter.html
     Drop-in page for GitHub Pages.
     Uses NiiVue + @niivue/dicom-loader (dcm2niix WASM) to convert DICOM → NIfTI locally in the browser.
-->
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>DICOM → NIfTI converter (browser-only)</title>
  <style>
    :root{
      --bg:#0b0b0c;
      --panel:#121214;
      --panel2:#0f0f11;
      --border:#232326;
      --text:#eaeaea;
      --muted:#b8b8b8;
      --muted2:#8a8a8a;
      --accent:#7dd3fc;
      --danger:#fb7185;
      --ok:#34d399;
      --btn:#17171a;
      --btn2:#1c1c20;
      --shadow: 0 10px 30px rgba(0,0,0,.45);
      --radius:14px;
      --radius2:10px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
      background: var(--bg);
      color: var(--text);
    }

    /* Layout */
    .wrap{
      max-width: 1400px;
      margin: 0 auto;
      padding: 28px 18px 40px;
    }
    header{
      margin-bottom: 18px;
    }
    h1{
      margin: 0 0 6px 0;
      font-size: 22px;
      font-weight: 700;
      letter-spacing:.2px;
    }
    .sub{
      margin:0;
      color: var(--muted);
      font-size: 14px;
      line-height: 1.35;
    }
    .sub code{
      background: rgba(255,255,255,.06);
      padding: 2px 6px;
      border-radius: 8px;
      border: 1px solid rgba(255,255,255,.08);
    }

    .grid{
      margin-top: 18px;
      display: grid;
      grid-template-columns: 420px 1fr;
      gap: 14px;
      align-items: stretch;
      min-height: 680px;
    }
    @media (max-width: 980px){
      .grid{ grid-template-columns: 1fr; }
    }

    .card{
      background: linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.02));
      border: 1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow: hidden;
    }
    .card .inner{
      padding: 14px;
    }
    .card h2{
      margin: 0 0 10px 0;
      font-size: 14px;
      letter-spacing:.2px;
      color: #ffffff;
      font-weight: 700;
    }
    .muted{
      color: var(--muted2);
      font-size: 13px;
      line-height: 1.35;
      margin: 0 0 12px 0;
    }

    .btnrow{
      display:flex;
      gap: 10px;
      flex-wrap: wrap;
      margin-bottom: 12px;
    }
    button{
      appearance:none;
      border: 1px solid rgba(255,255,255,.10);
      background: var(--btn);
      color: var(--text);
      border-radius: 12px;
      padding: 9px 12px;
      font-size: 13px;
      cursor: pointer;
      transition: transform .03s ease, background .12s ease, border-color .12s ease;
    }
    button:hover{ background: var(--btn2); border-color: rgba(255,255,255,.16); }
    button:active{ transform: translateY(1px); }
    button.primary{
      border-color: rgba(125,211,252,.35);
    }
    button.danger{
      border-color: rgba(251,113,133,.35);
      color: #ffd7de;
    }
    button:disabled{
      opacity:.55;
      cursor:not-allowed;
    }

    .box{
      background: rgba(0,0,0,.25);
      border: 1px dashed rgba(255,255,255,.18);
      border-radius: 14px;
      padding: 12px;
      margin-bottom: 12px;
    }
    .box strong{ color:#fff; }
    .small{
      font-size: 12.5px;
      color: var(--muted);
      margin: 8px 0 0 0;
    }

    textarea, input[type="text"]{
      width:100%;
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.25);
      color: var(--text);
      padding: 10px 10px;
      font-size: 13px;
      outline: none;
    }
    textarea{
      resize: vertical;
      min-height: 104px;
      line-height: 1.35;
    }
    .hint{
      font-size: 12px;
      color: var(--muted2);
      margin-top: 8px;
    }

    .status{
      border-top: 1px solid rgba(255,255,255,.06);
      background: rgba(0,0,0,.22);
      padding: 10px 12px;
      font-size: 12.5px;
      color: var(--muted);
      display:flex;
      gap:10px;
      align-items:flex-start;
    }
    .dot{
      width: 10px;
      height: 10px;
      border-radius: 99px;
      background: rgba(255,255,255,.18);
      margin-top: 3px;
      flex: 0 0 auto;
    }
    .dot.ok{ background: rgba(52,211,153,.85); }
    .dot.bad{ background: rgba(251,113,133,.85); }
    .dot.work{ background: rgba(125,211,252,.85); }

    /* Viewer */
    .viewerHead{
      padding: 10px 12px;
      border-bottom: 1px solid rgba(255,255,255,.06);
      display:flex;
      justify-content: space-between;
      align-items: center;
      background: rgba(0,0,0,.18);
    }
    .viewerHead .title{
      font-size: 13px;
      font-weight: 700;
      color: #fff;
    }
    .viewerHead .meta{
      font-size: 12px;
      color: var(--muted2);
    }
    .viewerWrap{
      position: relative;
      height: calc(100% - 42px);
      min-height: 620px;
      background: #000;
    }
    canvas{
      width: 100%;
      height: 100%;
      display:block;
      outline: none;
    }
    .dropOverlay{
      position:absolute;
      inset: 10px;
      border-radius: 16px;
      border: 1px solid rgba(255,255,255,.10);
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02));
      pointer-events: none; /* becomes enabled only during drag */
      opacity: 0;
      transition: opacity .12s ease;
      display:flex;
      align-items:center;
      justify-content:center;
      text-align:center;
      padding: 18px;
    }
    .dropOverlay.active{
      opacity: 1;
      pointer-events: auto;
      border: 1px dashed rgba(125,211,252,.55);
      box-shadow: 0 0 0 2px rgba(125,211,252,.12) inset;
      background: linear-gradient(180deg, rgba(125,211,252,.10), rgba(0,0,0,.25));
    }
    .dropOverlay .big{
      font-weight: 800;
      letter-spacing:.2px;
      margin-bottom: 6px;
    }
    .dropOverlay .small2{
      color: var(--muted);
      font-size: 13px;
      line-height: 1.35;
    }

    /* Hidden inputs */
    input[type="file"]{ display:none; }
  </style>
</head>

<body>
  <div class="wrap">
    <header>
      <h1>DICOM → NIfTI converter (runs in your browser)</h1>
      <p class="sub">
        No uploads to a server. Conversion happens locally using <code>NiiVue</code> + <code>@niivue/dicom-loader</code> (dcm2niix WASM).
        Drop a DICOM folder onto the viewer, or pick a folder. You can also load a DICOM manifest (newline-separated URLs/paths).
      </p>
    </header>

    <div class="grid">
      <!-- LEFT: Controls -->
      <section class="card">
        <div class="inner">
          <h2>1) Convert from local DICOMs</h2>

          <div class="btnrow">
            <button id="btnPickFolder" class="primary">Choose DICOM folder</button>
            <button id="btnClear" class="danger">Clear</button>
            <button id="btnSave" disabled>Save NIfTI</button>
          </div>

          <div class="box">
            <div class="muted" style="margin:0;">
              <strong>Fast path:</strong> drag-and-drop a <strong>folder</strong> of DICOM slices onto the black viewer on the right.
              <div class="small">
                If Chrome opens a blank tab, your drop is landing outside the viewer. Drop directly onto the viewer (or use “Choose DICOM folder”).
              </div>
            </div>
          </div>

          <p class="muted" style="margin-top:14px;">
            2) Load a DICOM manifest (URLs)
          </p>
          <textarea id="manifestText" placeholder="Paste a manifest URL here (e.g., ./data/my_series_manifest.txt)&#10;or multiple URLs/paths, one per line"></textarea>

          <div class="btnrow" style="margin-top:10px;">
            <button id="btnLoadManifestUrl">Load manifest URL(s)</button>
            <button id="btnLoadManifestFile">Load manifest file</button>
          </div>

          <div class="hint">
            A “manifest” is a plain text file listing relative URLs/paths to each DICOM slice (one per line) in order.
          </div>

          <input id="folderInput" type="file" webkitdirectory directory multiple />
          <input id="manifestFileInput" type="file" accept=".txt" />
        </div>

        <div class="status">
          <div id="statusDot" class="dot"></div>
          <div id="statusText">Ready.</div>
        </div>
      </section>

      <!-- RIGHT: Viewer -->
      <section class="card">
        <div class="viewerHead">
          <div>
            <div class="title">Viewer</div>
            <div class="meta" id="viewerMeta">No volume loaded</div>
          </div>
          <div class="meta" id="buildMeta"></div>
        </div>
        <div class="viewerWrap" id="viewerWrap">
          <canvas id="niivue-canvas" tabindex="0"></canvas>
          <div class="dropOverlay" id="dropOverlay">
            <div>
              <div class="big">Drop your DICOM folder here</div>
              <div class="small2">Conversion stays on your machine. Large series can take a bit.</div>
            </div>
          </div>
        </div>
      </section>
    </div>
  </div>

  <script type="module">
    // Versions: align with current docs (API v0.66.0 shown on site).
    // If you update these, update both imports together.
    import { Niivue } from "https://esm.sh/@niivue/niivue@0.66.0";
    import { dicomLoader } from "https://esm.sh/@niivue/dicom-loader@1.0.0";

    const $ = (id) => document.getElementById(id);

    const statusDot = $("statusDot");
    const statusText = $("statusText");
    const viewerMeta = $("viewerMeta");
    const buildMeta = $("buildMeta");
    const dropOverlay = $("dropOverlay");

    const btnPickFolder = $("btnPickFolder");
    const btnClear = $("btnClear");
    const btnSave = $("btnSave");
    const btnLoadManifestUrl = $("btnLoadManifestUrl");
    const btnLoadManifestFile = $("btnLoadManifestFile");

    const folderInput = $("folderInput");
    const manifestText = $("manifestText");
    const manifestFileInput = $("manifestFileInput");
    const canvas = $("niivue-canvas");
    const viewerWrap = $("viewerWrap");

    let nv = null;
    let lastSuggestedName = "converted.nii.gz";

    function setStatus(kind, msg){
      statusDot.className = "dot" + (kind ? " " + kind : "");
      statusText.textContent = msg;
    }

    function getLoadedVolume(){
      // Niivue keeps volumes in nv.volumes (array). We only care about the first one here.
      if (!nv) return null;
      if (!Array.isArray(nv.volumes) || nv.volumes.length < 1) return null;
      return nv.volumes[0] ?? null;
    }

    function updateUI(){
      const vol = getLoadedVolume();
      const hasVol = !!vol;

      btnSave.disabled = !hasVol;

      if (!hasVol){
        viewerMeta.textContent = "No volume loaded";
        return;
      }

      // Try to display something sensible.
      const name = vol?.name || vol?.hdr?.name || "volume";
      viewerMeta.textContent = `Loaded: ${name}`;
      // Use the file name as default download suggestion.
      if (typeof name === "string" && name.trim().length){
        // If already .nii, suggest .nii.gz
        const base = name.replace(/\.(nii|nii\.gz|dcm|dicom)$/i, "");
        lastSuggestedName = `${base}.nii.gz`;
      }
    }

    async function init(){
      setStatus("", "Initialising viewer…");

      nv = new Niivue({
        backColor: [0, 0, 0, 1],
        textHeight: 0.04
      });

      // Register the DICOM loader (required for DICOM + folder drop handling).
      // This matches the NiiVue docs for DICOM loading. :contentReference[oaicite:0]{index=0}
      nv.useDicomLoader({ loader: dicomLoader });

      // Attach viewer.
      await nv.attachToCanvas(canvas);

      // Keep drag-and-drop enabled (default is true, but be explicit).
      nv.opts.dragAndDropEnabled = true;

      // A simple default view.
      nv.setSliceType(nv.sliceTypeMultiplanar || 3); // fallback if enums change
      nv.drawScene();

      // Helpful metadata.
      buildMeta.textContent = "NiiVue + dicom-loader (dcm2niix WASM)";
      setStatus("ok", "Ready. Drop a DICOM folder onto the viewer.");
      updateUI();

      // Listen for Niivue load events if present.
      // Not all builds expose the same callbacks, so keep it defensive.
      if (typeof nv.onImageLoaded === "function") {
        const prev = nv.onImageLoaded;
        nv.onImageLoaded = (...args) => {
          try { prev(...args); } catch {}
          updateUI();
        };
      }

      // Make the whole viewer area a safe drop target:
      // - Prevent the browser from navigating away (your white new-tab issue)
      // - Forward the event to Niivue's built-in drop handler (dropListener) :contentReference[oaicite:1]{index=1}
      const prevent = (e) => {
        e.preventDefault();
        e.stopPropagation();
      };

      const onDragEnter = (e) => {
        prevent(e);
        dropOverlay.classList.add("active");
      };

      const onDragOver = (e) => {
        prevent(e);
        dropOverlay.classList.add("active");
      };

      const onDragLeave = (e) => {
        prevent(e);
        // Only hide when leaving the viewer area (not when moving between children).
        if (e.target === viewerWrap || e.target === canvas) {
          dropOverlay.classList.remove("active");
        }
      };

      const onDrop = async (e) => {
        prevent(e);
        dropOverlay.classList.remove("active");

        try{
          setStatus("work", "Loading dropped data…");
          // Forward the real drop event to Niivue so it can handle DICOM folders properly.
          await nv.dropListener(e);
          setStatus("ok", "Loaded.");
          updateUI();
        } catch (err){
          console.error(err);
          setStatus("bad", "Drop failed. Try dropping directly onto the black viewer, or use “Choose DICOM folder”.");
        }
      };

      // Bind to viewer wrap and canvas.
      [viewerWrap, canvas].forEach((el) => {
        el.addEventListener("dragenter", onDragEnter);
        el.addEventListener("dragover", onDragOver);
        el.addEventListener("dragleave", onDragLeave);
        el.addEventListener("drop", onDrop);
      });

      // Also prevent the window from hijacking drops (this is what causes navigation/new blank tab).
      // We *do not* forward these to Niivue unless it happens over the viewer.
      window.addEventListener("dragover", (e) => e.preventDefault());
      window.addEventListener("drop", (e) => e.preventDefault());
    }

    // Convert folder picker → synthetic drop event (so Niivue uses the same robust path).
    async function handleFolderPicked(files){
      if (!files || files.length < 1) return;

      // Build a DataTransfer that Niivue's dropListener can understand.
      // Chrome/Edge support programmatic DataTransfer; Safari may be limited.
      const dt = new DataTransfer();
      for (const f of files) dt.items.add(f);

      const syntheticEvent = new DragEvent("drop", {
        dataTransfer: dt,
        bubbles: true,
        cancelable: true
      });

      try{
        setStatus("work", `Loading ${files.length} file(s)…`);
        await nv.dropListener(syntheticEvent);
        setStatus("ok", "Loaded.");
        updateUI();
      } catch (err){
        console.error(err);
        setStatus("bad", "Folder load failed. If this is Safari, use Chrome/Edge for folder-based DICOM conversion.");
      }
    }

    // Load manifest URL(s) (newline-separated). Uses Niivue's loadDicoms with isManifest.
    // This matches the NiiVue docs for DICOM manifests. :contentReference[oaicite:2]{index=2}
    async function loadManifestUrls(lines){
      const urls = lines
        .map(s => s.trim())
        .filter(Boolean);

      if (urls.length < 1){
        setStatus("bad", "No manifest URL/path provided.");
        return;
      }

      try{
        setStatus("work", "Loading manifest…");
        // Load sequentially so status is predictable.
        for (const url of urls){
          await nv.loadDicoms([{ url, isManifest: true }]);
        }
        setStatus("ok", "Loaded manifest.");
        updateUI();
      } catch (err){
        console.error(err);
        setStatus("bad", "Manifest load failed. Check the path/URL and ensure it’s accessible from this site.");
      }
    }

    // Buttons
    btnPickFolder.addEventListener("click", () => folderInput.click());

    folderInput.addEventListener("change", async () => {
      const files = Array.from(folderInput.files || []);
      // Reset input so picking the same folder again still fires change.
      folderInput.value = "";
      await handleFolderPicked(files);
    });

    btnClear.addEventListener("click", () => {
      try{
        if (!nv) return;
        nv.volumes = [];
        nv.meshes = [];
        nv.drawScene();
      } catch {}
      setStatus("ok", "Cleared.");
      updateUI();
    });

    btnSave.addEventListener("click", async () => {
      const vol = getLoadedVolume();
      if (!vol){
        setStatus("bad", "Nothing to save.");
        return;
      }
      try{
        setStatus("work", "Preparing download…");
        // NVImage.saveToDisk triggers a browser download.
        // (Method exists on NVImage in NiiVue builds.) :contentReference[oaicite:3]{index=3}
        await vol.saveToDisk(lastSuggestedName);
        setStatus("ok", `Saved: ${lastSuggestedName}`);
      } catch (err){
        console.error(err);
        setStatus("bad", "Save failed in this browser build. If it keeps failing, try Chrome/Edge.");
      }
    });

    btnLoadManifestUrl.addEventListener("click", async () => {
      const lines = manifestText.value.split(/\r?\n/);
      await loadManifestUrls(lines);
    });

    btnLoadManifestFile.addEventListener("click", () => manifestFileInput.click());

    manifestFileInput.addEventListener("change", async () => {
      const file = (manifestFileInput.files || [])[0];
      manifestFileInput.value = "";
      if (!file) return;

      try{
        const text = await file.text();
        manifestText.value = text.trim();
        const lines = text.split(/\r?\n/);
        await loadManifestUrls(lines);
      } catch (err){
        console.error(err);
        setStatus("bad", "Could not read manifest file.");
      }
    });

    // Start
    init().catch((err) => {
      console.error(err);
      setStatus("bad", "Failed to initialise. Check the browser console for details.");
    });
  </script>
</body>
</html>
