<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>NiiVue - Zero Dependency</title>
  <style>
    body { margin: 0; background: #000; color: #fff; font-family: sans-serif; height: 100vh; display: flex; flex-direction: column; overflow: hidden; }
    header { background: #222; padding: 15px; border-bottom: 1px solid #444; display: flex; justify-content: space-between; align-items: center; }
    #status { color: #aaa; font-size: 14px; }
    canvas { flex: 1; outline: none; }
    .overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 100; display: flex; align-items: center; justify-content: center; background: rgba(0,0,0,0.8); pointer-events: none; opacity: 0; transition: opacity 0.2s; }
    .overlay.active { opacity: 1; pointer-events: auto; }
    .box { border: 2px dashed #666; padding: 40px; border-radius: 12px; text-align: center; background: #222; pointer-events: auto; }
    button { padding: 10px 20px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 16px; margin-top: 15px; }
  </style>
</head>
<body>

<header>
  <strong>NiiVue DICOM Viewer</strong>
  <div id="status">Loading...</div>
</header>

<div id="overlay" class="overlay active">
  <div class="box">
    <h2>Drag DICOM Folder Here</h2>
    <p>or</p>
    <input type="file" id="fileInput" multiple webkitdirectory style="display:none">
    <button onclick="document.getElementById('fileInput').click()">Select Folder</button>
  </div>
</div>

<canvas id="gl"></canvas>

<script src="https://cdn.jsdelivr.net/npm/@niivue/niivue@0.42.0/dist/niivue.umd.js"></script>

<script>
  // --- VIEWER LOGIC ---
  const statusEl = document.getElementById('status');
  const overlay = document.getElementById('overlay');
  let nv;

  window.onload = function() {
    if (typeof niivue === 'undefined') {
      statusEl.innerText = "‚ùå BLOCKED: Your network or browser is blocking the CDN library.";
      statusEl.style.color = "red";
      // This confirms it's a local network block if it fails here.
      return;
    }

    try {
      nv = new niivue.Niivue();
      nv.attachTo('gl');
      nv.setSliceType(nv.sliceTypeMultiplanar); // 4-Panel View
      nv.setMeshProperty(0, {rgba255: [0, 0, 0, 255]});
      statusEl.innerText = "‚úÖ Ready";
      statusEl.style.color = "#0f0";
    } catch (e) {
      statusEl.innerText = "‚ùå Init Error: " + e.message;
    }
  };

  // Drag & Drop
  document.body.ondragover = (e) => e.preventDefault();
  document.body.ondrop = async (e) => {
    e.preventDefault();
    overlay.classList.remove('active');
    statusEl.innerText = "üìÇ Reading...";
    
    const items = e.dataTransfer.items;
    if (items) {
      const files = await scanFiles(items);
      if(files.length > 0) loadFiles(files);
    }
  };

  // File Input
  document.getElementById('fileInput').onchange = (e) => {
    overlay.classList.remove('active');
    loadFiles(e.target.files);
  };

  async function loadFiles(fileList) {
    if (!nv) return;
    const files = Array.from(fileList).filter(f => !f.name.startsWith('.'));
    statusEl.innerText = `‚è≥ Loading ${files.length} DICOMs...`;
    
    try {
      if(nv.loadFromFiles) await nv.loadFromFiles(files);
      else await nv.loadFromFileList(files);
      
      if (nv.volumes.length > 0) statusEl.innerText = "‚úÖ Loaded: " + nv.volumes[0].name;
      else statusEl.innerText = "‚ùå No Volume Created";
    } catch (err) {
      statusEl.innerText = "‚ùå Error: " + err.message;
    }
  }

  async function scanFiles(items) {
    let files = [];
    let queue = [];
    for (let i=0; i<items.length; i++) queue.push(items[i].webkitGetAsEntry());
    while (queue.length > 0) {
      let entry = queue.shift();
      if (entry.isFile) files.push(await new Promise(r => entry.file(r)));
      else if (entry.isDirectory) {
        let reader = entry.createReader();
        queue.push(...await new Promise(r => reader.readEntries(r)));
      }
    }
    return files;
  }
</script>

</body>
</html>
