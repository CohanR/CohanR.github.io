<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <title>Remy Cohan • Neuropsis • MNI Atlas Viewer (Desikan + 3D)</title>
  <meta name="description" content="Remy Cohan (Neuropsis) — interactive MNI152 viewer with Desikan atlas overlay and 3D surface rendering. Runs locally in your browser; no uploads." />
  <meta name="author" content="Remy Cohan" />
  <meta name="keywords" content="Remy Cohan, Neuropsis, NiiVue, MNI152, Desikan, atlas, NIfTI, neuroimaging, TMS, neuromodulation" />

  <!-- Social preview -->
  <meta property="og:title" content="Remy Cohan • Neuropsis • MNI Atlas Viewer (Desikan + 3D)" />
  <meta property="og:description" content="Local-only MNI152 viewer with Desikan atlas overlay + 3D surface. No uploads." />
  <meta property="og:type" content="website" />

  <style>
    :root { color-scheme: dark; }
    * { box-sizing: border-box; }
    body {
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      background:#070a0f;
      color:#e6edf7;
    }
    header {
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding:14px 16px;
      border-bottom:1px solid rgba(255,255,255,0.08);
    }
    .brand { display:flex; flex-direction:column; gap:2px; }
    .brand h1 { margin:0; font-size:16px; letter-spacing:0.2px; }
    .brand .sub { opacity:0.75; font-size:12px; }
    .actions { display:flex; gap:10px; align-items:center; }

    button, .btn {
      appearance:none;
      border:1px solid rgba(255,255,255,0.14);
      background: rgba(20,30,50,0.45);
      color:#e6edf7;
      padding:8px 12px;
      border-radius:10px;
      cursor:pointer;
      font-size:13px;
      text-decoration:none;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      user-select:none;
    }
    button:hover, .btn:hover { border-color: rgba(120,170,255,0.55); }
    button:disabled { opacity:0.5; cursor:not-allowed; }

    main {
      display:grid;
      grid-template-columns: 380px 1fr;
      gap:14px;
      padding:14px;
    }
    .panel {
      border:1px solid rgba(255,255,255,0.08);
      background: rgba(10,14,22,0.7);
      border-radius:14px;
      padding:14px;
      height: calc(100vh - 86px);
      overflow:auto;
    }
    .panel h2 { margin:0 0 10px; font-size:14px; opacity:0.9; }
    label { font-size:12px; opacity:0.8; display:block; margin:10px 0 6px; }
    input[type="range"] { width:100%; }
    input[type="file"] { width:100%; }
    .row { display:flex; gap:10px; align-items:center; margin:10px 0; flex-wrap:wrap; }
    .hint { font-size:12px; opacity:0.7; line-height:1.35; margin-top:10px; }
    .kv { display:grid; grid-template-columns: 120px 1fr; gap:8px 10px; font-size:12px; opacity:0.92; margin-top:10px; }
    .kv div:nth-child(odd) { opacity:0.7; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }

    .viewerWrap {
      border-radius:14px;
      border:1px solid rgba(255,255,255,0.08);
      overflow:hidden;
      height: calc(100vh - 86px);
      background:#000;
    }
    #gl {
      width:100%;
      height:100%;
      display:block;
    }

    .pill {
      display:inline-flex;
      gap:8px;
      align-items:center;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,0.12);
      background: rgba(20,30,50,0.35);
      font-size:12px;
      opacity:0.9;
    }

    .errorBox {
      margin-top:12px;
      padding:10px 12px;
      border-radius:12px;
      border:1px solid rgba(255,120,120,0.25);
      background: rgba(90,20,20,0.25);
      font-size:12px;
      line-height:1.4;
      white-space:pre-wrap;
    }
  </style>

  <!-- IMPORTANT: use the UMD build so `Niivue` exists as a global -->
  <script src="./assets/vendor/niivue/niivue.umd.js"></script>
</head>

<body>
<header>
  <div class="brand">
    <h1>MNI Atlas Viewer (Desikan + 3D)</h1>
    <div class="sub">Remy Cohan • Neuropsis • local-only • no uploads</div>
  </div>
  <div class="actions">
    <a class="btn" href="/">Home</a>
    <button type="button" onclick="history.back()">Back</button>
  </div>
</header>

<main>
  <section class="panel">
    <h2>Controls</h2>

    <div class="row">
      <button id="btnLoadDefaults" type="button">Load template + atlas + mesh</button>
      <button id="btnClear" type="button">Clear</button>
    </div>

    <div class="row">
      <button id="mode2D" type="button">3-plane</button>
      <button id="mode3D" type="button">3D render</button>
      <button id="modeBoth" type="button">3-plane + 3D</button>
    </div>

    <label for="atlasOpacity">Atlas opacity</label>
    <input id="atlasOpacity" type="range" min="0" max="1" step="0.01" value="0.35" />

    <label for="userNifti">Optional: load your own NIfTI (underlay)</label>
    <input id="userNifti" type="file" accept=".nii,.nii.gz,application/gzip" />

    <div class="kv">
      <div>Status</div><div id="statusLine" class="pill">Ready.</div>
      <div>Atlas label</div><div id="labelLine">—</div>
      <div>Loaded</div><div id="loadedLine" class="mono">—</div>
    </div>

    <p class="hint">
      This viewer runs entirely in your browser. Nothing uploads.
      The Desikan file is a label volume (overlay). For a clean anatomical underlay, this page auto-tries
      <span class="mono">images/mni152.nii.gz</span> or <span class="mono">images/mni152.nii</span> if present.
    </p>

    <div id="fatalError" class="errorBox" style="display:none;"></div>
  </section>

  <section class="viewerWrap">
    <canvas id="gl"></canvas>
  </section>
</main>

<script>
(() => {
  const statusLine = document.getElementById("statusLine");
  const labelLine  = document.getElementById("labelLine");
  const loadedLine = document.getElementById("loadedLine");
  const fatalBox   = document.getElementById("fatalError");

  function setStatus(msg) { statusLine.textContent = msg; }
  function setFatal(msg) {
    fatalBox.style.display = "block";
    fatalBox.textContent = msg;
  }

  // If this fails, it's *always* because the wrong file was loaded (ESM as classic script),
  // or the path is wrong.
  if (typeof window.Niivue === "undefined") {
    setStatus("ERROR: NiiVue not loaded");
    setFatal(
`NiiVue didn't load.

Fix:
1) Confirm this URL loads (not 404):
   ${new URL("./assets/vendor/niivue/niivue.umd.js", document.baseURI).toString()}

2) Make sure you are using the UMD build (niivue.umd.js) in the <script src="..."> tag.
   The "min" file is often ESM and will NOT create window.Niivue.`
    );
    return;
  }

  // Robust URL helper (works even if you later move the HTML into a subfolder)
  const U = (rel) => new URL(rel, document.baseURI).toString();

  // Your repo assets
  const PATHS = {
    underlayCandidates: [
      "./images/mni152.nii.gz",
      "./images/mni152.nii",
      "./assets/neurop/MNI152_T1_1mm.nii.gz",
      "./assets/neurop/MNI152_T1_1mm_brain.nii.gz"
    ],
    atlas: "./assets/neurop/MNI152_T1_1mm_desikan_adjusted.nii.gz",
    atlasLabels: "./assets/neurop/MNI152_T1_1mm_desikan_adjusted.txt",
    mesh: "./assets/neurop/mni152_2009.mz3"
  };

  // Parse Desikan label file: "int  label"
  const labelMap = new Map();
  async function loadLabelMap() {
    const r = await fetch(U(PATHS.atlasLabels), { cache: "no-store" });
    if (!r.ok) throw new Error(`Label file fetch failed (HTTP ${r.status})`);
    const txt = await r.text();
    txt.split(/\r?\n/).forEach(line => {
      const s = line.trim();
      if (!s) return;
      const m = s.match(/^(\d+)\s+(.*)$/);
      if (!m) return;
      labelMap.set(parseInt(m[1], 10), m[2].trim());
    });
  }

  // NiiVue init
  const nv = new window.Niivue({
    backColor: [0,0,0,1],
    isColorbar: false,
    show3Dcrosshair: true
  });

  nv.attachTo("gl");
  nv.setSliceType(nv.sliceTypeMultiplanarRender);

  function safeCloseAll() {
    try { nv.closeAllMeshes(); } catch {}
    try { nv.closeAllVolumes(); } catch {}
    try { nv.updateGLVolume(); } catch {}
    labelLine.textContent = "—";
    loadedLine.textContent = "—";
  }

  async function loadUnderlayBestEffort() {
    for (const rel of PATHS.underlayCandidates) {
      try {
        await nv.loadVolumes([{ url: U(rel), name: "Underlay", opacity: 1.0 }]);
        return rel;
      } catch (e) {}
    }
    return null;
  }

  async function loadAtlasOverlay(opacity) {
    // add overlay as a second volume (if no underlay, it'll still load as the only volume)
    // Using nearest neighbour for labels.
    await nv.addVolumeFromUrl({
      url: U(PATHS.atlas),
      name: "Desikan",
      opacity: opacity,
      colormap: "random",
      isNearestInterpolation: true
    });
  }

  async function loadMeshBestEffort() {
    try {
      await nv.loadMeshes([{ url: U(PATHS.mesh), name: "mni152_2009" }]);
      return true;
    } catch (e) {
      return false;
    }
  }

  // Best-effort label readout across versions:
  // NiiVue versions differ; many expose an onLocationChange callback with intensity info.
  function wireLabelReadout() {
    // Pattern A: nv.onLocationChange = (loc) => ...
    try {
      nv.onLocationChange = (loc) => {
        // Try common shapes:
        // - loc.values (array) with per-volume intensity
        // - loc.string contains a formatted intensity readout
        // We'll attempt to extract the atlas value.
        let atlasVal = null;

        if (loc && Array.isArray(loc.values)) {
          // Assume atlas is the last loaded volume (usually true: underlay first, atlas second)
          // If only atlas is loaded, it's [0].
          atlasVal = loc.values[loc.values.length - 1];
        } else if (loc && typeof loc.string === "string") {
          // Fallback: attempt to grab last numeric token
          const nums = loc.string.match(/-?\d+(\.\d+)?/g);
          if (nums && nums.length) atlasVal = nums[nums.length - 1];
        }

        if (atlasVal == null) return;
        const id = Math.round(Number(atlasVal));
        if (!Number.isFinite(id)) return;

        const name = labelMap.get(id);
        labelLine.textContent = name ? name : (id === 0 ? "Background (0)" : `Label ${id}`);
      };
    } catch (e) {
      // If it fails, ignore — viewer still works.
    }
  }

  async function loadDefaults() {
    setStatus("Loading…");
    safeCloseAll();

    let loaded = [];

    // label map first (so label readout works immediately)
    try {
      await loadLabelMap();
    } catch (e) {
      // not fatal
    }

    // underlay (optional)
    const underlayRel = await loadUnderlayBestEffort();
    if (underlayRel) loaded.push(`Underlay: ${underlayRel}`);
    else loaded.push("Underlay: not found (ok)");

    // atlas overlay (required for your use case)
    const op = parseFloat(document.getElementById("atlasOpacity").value);
    await loadAtlasOverlay(op);
    loaded.push(`Atlas: ${PATHS.atlas}`);

    // mesh (optional)
    const meshOk = await loadMeshBestEffort();
    loaded.push(meshOk ? `Mesh: ${PATHS.mesh}` : `Mesh: failed (check ${PATHS.mesh})`);

    try { nv.updateGLVolume(); } catch {}

    loadedLine.textContent = loaded.join(" • ");
    wireLabelReadout();
    setStatus("Loaded");
  }

  async function loadUserNifti(file) {
    setStatus("Loading NIfTI…");
    safeCloseAll();

    // Load user file as underlay
    await nv.loadFromFile(file);

    // Then add atlas + mesh
    try { await loadLabelMap(); } catch {}
    const op = parseFloat(document.getElementById("atlasOpacity").value);
    await loadAtlasOverlay(op);
    const meshOk = await loadMeshBestEffort();

    try { nv.updateGLVolume(); } catch {}
    wireLabelReadout();

    loadedLine.textContent =
      `Underlay: ${file.name} • Atlas: ${PATHS.atlas} • Mesh: ${meshOk ? PATHS.mesh : "failed"}`;

    setStatus("Loaded");
  }

  // UI wiring
  document.getElementById("btnLoadDefaults").addEventListener("click", () => {
    loadDefaults().catch(err => {
      console.error(err);
      setStatus("ERROR");
      setFatal(String(err?.message || err));
    });
  });

  document.getElementById("btnClear").addEventListener("click", () => {
    safeCloseAll();
    setStatus("Cleared");
  });

  document.getElementById("mode2D").addEventListener("click", () => {
    nv.setSliceType(nv.sliceTypeMultiplanar);
    try { nv.updateGLVolume(); } catch {}
    setStatus("Mode: 3-plane");
  });

  document.getElementById("mode3D").addEventListener("click", () => {
    nv.setSliceType(nv.sliceTypeRender);
    try { nv.updateGLVolume(); } catch {}
    setStatus("Mode: 3D render");
  });

  document.getElementById("modeBoth").addEventListener("click", () => {
    nv.setSliceType(nv.sliceTypeMultiplanarRender);
    try { nv.updateGLVolume(); } catch {}
    setStatus("Mode: 3-plane + 3D");
  });

  document.getElementById("atlasOpacity").addEventListener("input", (ev) => {
    const v = parseFloat(ev.target.value);
    const vols = nv.volumes || [];
    // Try to find the Desikan overlay volume
    const idx = vols.findIndex(vol => (vol?.name || "").toLowerCase().includes("desikan"));
    if (idx >= 0) {
      vols[idx].opacity = v;
      try { nv.updateGLVolume(); } catch {}
    }
  });

  document.getElementById("userNifti").addEventListener("change", (ev) => {
    const f = ev.target.files && ev.target.files[0];
    if (!f) return;
    loadUserNifti(f).catch(err => {
      console.error(err);
      setStatus("ERROR");
      setFatal(String(err?.message || err));
    });
  });

  // Auto-load defaults on page load
  loadDefaults().catch(err => {
    console.error(err);
    setStatus("ERROR");
    setFatal(String(err?.message || err));
  });
})();
</script>
</body>
</html>
