<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Remy Cohan | TMS Target Visualiser (NIfTI)</title>
  <meta name="description" content="Interactive TMS targeting visualiser by Remy Cohan. Click-to-place targets on MRI, view coordinates, and explore coil orientation using an in-browser NIfTI viewer (NiiVue)." />
  <meta name="author" content="Remy Cohan" />
  <meta name="robots" content="index,follow" />
  <style>
    :root { --bg:#0b0f14; --panel:#101826; --line:#223247; --text:#e7eef7; --muted:#9fb0c2; --btn:#152236; --btnh:#1b2c45; }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;background:var(--bg);color:var(--text)}
    header{padding:14px 16px;border-bottom:1px solid var(--line);background:rgba(16,24,38,.7);position:sticky;top:0;z-index:10}
    header .top{display:flex;gap:10px;align-items:center;justify-content:space-between;flex-wrap:wrap}
    .btn{border:1px solid var(--line);background:var(--btn);color:var(--text);padding:8px 10px;border-radius:10px;cursor:pointer;font-size:12px}
    .btn:hover{background:var(--btnh)}
    .wrap{max-width:1200px;margin:0 auto;padding:14px;display:grid;grid-template-columns:360px 1fr;gap:14px}
    .card{background:rgba(16,24,38,.9);border:1px solid var(--line);border-radius:14px;padding:12px}
    .small{font-size:12px;color:var(--muted);line-height:1.35}
    .kv{display:grid;grid-template-columns:120px 1fr;gap:8px 10px;align-items:center;font-size:12px;margin-top:10px}
    input[type="range"]{width:100%}
    main{background:rgba(16,24,38,.9);border:1px solid var(--line);border-radius:14px;overflow:hidden;min-height:680px}
    #gl{width:100%;height:680px;display:block}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .pill{padding:6px 10px;border:1px solid var(--line);border-radius:999px;font-size:12px;color:var(--muted);background:rgba(255,255,255,.02)}
    code{color:#b8c7ff}
  </style>

  <!-- NiiVue (ESM CDN). If you hate CDNs, you can vendor this file into your repo later. -->
  <script type="module">
    import { Niivue, SHOW_RENDER } from "https://unpkg.com/@niivue/niivue@0.45.1/dist/niivue.es.js";

    const els = {
      status: null, outX:null,outY:null,outZ:null,outAng:null,
      ang: null, loadNifti: null, viewMode: null, reset: null
    };

    const state = { x:0, y:0, z:0, ang:45 };
    let nv;

    function setStatus(s){ if(els.status) els.status.textContent = s; }

    function updateReadout() {
      els.outX.textContent = `${state.x.toFixed(1)} mm`;
      els.outY.textContent = `${state.y.toFixed(1)} mm`;
      els.outZ.textContent = `${state.z.toFixed(1)} mm`;
      els.outAng.textContent = `${Math.round(state.ang)}¬∞`;
    }

    function applyViewMode() {
      const mode = els.viewMode.value;
      if (mode === "mpr") {
        nv.setSliceType(3);
        nv.opts.multiplanarShowRender = SHOW_RENDER.NEVER;
      } else if (mode === "mpr3d") {
        nv.setSliceType(3);
        nv.opts.multiplanarShowRender = SHOW_RENDER.ALWAYS;
      } else {
        nv.setSliceType(4);
      }
      nv.drawScene();
    }

    function setTarget(mm) {
      state.x = mm[0]; state.y = mm[1]; state.z = mm[2];
      updateReadout();

      // Remove existing drawing layers and add a new marker + coil arrow overlay
      nv.drawings = [];
      nv.addText3D("TARGET", [state.x, state.y, state.z], 14, [1,1,1,1]);

      // Simple ‚Äúcoil orientation‚Äù arrow drawn as two points in world coords
      const ang = (state.ang * Math.PI) / 180;
      const len = 25; // mm
      const tip = [state.x + Math.cos(ang)*len, state.y + Math.sin(ang)*len, state.z];
      nv.addLine([state.x, state.y, state.z], tip, [0.12, 0.79, 0.59, 1.0]); // teal-ish
      nv.drawScene();
    }

    async function loadDefaultBrain() {
      // Public demo NIfTI. Replace later with your own hosted demo brain if you want.
      // This one is lightweight and stable.
      const demo = "https://niivue.github.io/niivue-demo-images/mni152.nii.gz";
      setStatus("Loading demo brain‚Ä¶");
      await nv.loadVolumes([{ url: demo, name: "MNI152", colormap: "gray" }]);
      setStatus("Loaded demo brain. Click anywhere to place a target.");
      // Set an initial target near left M1-ish
      setTarget([-38, -20, 56]);
      applyViewMode();
    }

    async function init() {
      // wire elements
      els.status = document.getElementById("status");
      els.outX = document.getElementById("outX");
      els.outY = document.getElementById("outY");
      els.outZ = document.getElementById("outZ");
      els.outAng = document.getElementById("outAng");
      els.ang = document.getElementById("ang");
      els.loadNifti = document.getElementById("loadNifti");
      els.viewMode = document.getElementById("viewMode");
      els.reset = document.getElementById("reset");

      nv = new Niivue({ backColor: [0,0,0,1], show3Dcrosshair: true });
      nv.attachToCanvas(document.getElementById("gl"));
      nv.opts.multiplanarEqualSize = true;

      // Click-to-target: use crosshair position in world mm
      nv.onLocationChange = (loc) => {
        // loc.mm is [x,y,z] in mm (when available)
        if (loc && loc.mm && loc.mm.length === 3) {
          setTarget(loc.mm);
        }
      };

      els.ang.addEventListener("input", () => {
        state.ang = parseFloat(els.ang.value);
        updateReadout();
        setTarget([state.x, state.y, state.z]);
      });

      els.viewMode.addEventListener("change", applyViewMode);

      els.reset.addEventListener("click", async () => {
        els.ang.value = "45";
        state.ang = 45;
        await loadDefaultBrain();
      });

      els.loadNifti.addEventListener("change", async (e) => {
        const f = e.target.files?.[0];
        if (!f) return;
        setStatus(`Loading ${f.name}‚Ä¶`);
        await nv.loadFromFile(f);
        setStatus(`Loaded ${f.name}. Click anywhere to place a target.`);
        applyViewMode();
      });

      await loadDefaultBrain();
    }

    window.addEventListener("DOMContentLoaded", init);
  </script>
</head>

<body>
<header>
  <div class="top">
    <div>
      <div style="font-weight:700">üß≤ TMS Target Visualiser</div>
      <div class="small">Remy Cohan ‚Ä¢ template brain + your NIfTI upload ‚Ä¢ click-to-target ‚Ä¢ MPR + 3D render</div>
    </div>
    <div class="row">
      <a class="btn" href="index.html">Home</a>
      <button class="btn" onclick="history.back()">Back</button>
      <span class="pill" id="status">Loading‚Ä¶</span>
    </div>
  </div>
</header>

<div class="wrap">
  <aside class="card">
    <div class="small">
      This is an educational targeting tool: it shows coordinates and coil orientation overlays on an MRI volume.
      It does not perform E-field modelling (use SimNIBS for that).
    </div>

    <div class="card" style="margin-top:12px">
      <div class="row" style="justify-content:space-between">
        <label class="small"><strong>Viewer mode</strong></label>
        <select id="viewMode" class="btn">
          <option value="mpr">3-plane (MPR)</option>
          <option value="mpr3d" selected>3-plane + 3D render</option>
          <option value="3d">3D render only</option>
        </select>
      </div>

      <div style="margin-top:12px">
        <label class="small"><strong>Load your NIfTI</strong> (<code>.nii</code> / <code>.nii.gz</code>)</label><br/>
        <input id="loadNifti" type="file" accept=".nii,.nii.gz" class="btn" style="margin-top:8px;width:100%" />
      </div>

      <div style="margin-top:12px">
        <label class="small"><strong>Coil orientation</strong> (concept, degrees)</label>
        <input id="ang" type="range" min="0" max="179" step="1" value="45" />
      </div>

      <div class="kv">
        <div class="small">X (L‚àí / R+)</div><div id="outX">‚Äî</div>
        <div class="small">Y (P‚àí / A+)</div><div id="outY">‚Äî</div>
        <div class="small">Z (I‚àí / S+)</div><div id="outZ">‚Äî</div>
        <div class="small">Coil angle</div><div id="outAng">‚Äî</div>
      </div>

      <div class="row" style="margin-top:12px">
        <button class="btn" id="reset">Reset demo</button>
      </div>
    </div>

    <div class="small" style="margin-top:12px">
      How to use:
      <ol class="small">
        <li>Click anywhere in the MRI to move the target.</li>
        <li>Change coil angle to rotate the arrow overlay.</li>
        <li>Switch to ‚Äú3-plane + 3D render‚Äù for the portfolio ‚Äúwow‚Äù factor.</li>
      </ol>
    </div>
  </aside>

  <main>
    <canvas id="gl"></canvas>
  </main>
</div>
</body>
</html>
