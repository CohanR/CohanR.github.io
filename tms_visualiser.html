<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Neuropsis • Atlas Viewer (MNI + Desikan)</title>
  <meta name="description" content="MNI viewer with Desikan atlas overlay and 3D surface. Runs locally in your browser." />
  <style>
    :root { color-scheme: dark; }
    body { margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial; background:#070a0f; color:#e6edf7; }
    header { display:flex; align-items:center; justify-content:space-between; padding:14px 16px; border-bottom:1px solid rgba(255,255,255,0.08); }
    .brand { display:flex; flex-direction:column; gap:2px; }
    .brand h1 { margin:0; font-size:16px; letter-spacing:0.2px; }
    .brand .sub { opacity:0.75; font-size:12px; }
    .actions { display:flex; gap:10px; align-items:center; }
    button, .btn {
      appearance:none; border:1px solid rgba(255,255,255,0.14);
      background: rgba(20,30,50,0.45);
      color:#e6edf7; padding:8px 12px; border-radius:10px;
      cursor:pointer; font-size:13px;
      text-decoration:none; display:inline-flex; align-items:center; justify-content:center;
    }
    button:hover, .btn:hover { border-color: rgba(120,170,255,0.55); }
    main { display:grid; grid-template-columns: 380px 1fr; gap:14px; padding:14px; }
    .panel { border:1px solid rgba(255,255,255,0.08); background: rgba(10,14,22,0.7); border-radius:14px; padding:14px; }
    .panel h2 { margin:0 0 10px; font-size:14px; opacity:0.9; }
    label { font-size:12px; opacity:0.8; display:block; margin:10px 0 6px; }
    input[type="range"] { width:100%; }
    input[type="file"] { width:100%; }
    .row { display:flex; gap:10px; align-items:center; margin:10px 0; flex-wrap:wrap; }
    .hint { font-size:12px; opacity:0.7; line-height:1.35; margin-top:8px; }
    .status { margin-top:10px; font-size:12px; opacity:0.85; white-space:pre-wrap; }
    #gl { width:100%; height: calc(100vh - 86px); display:block; border-radius:14px; border:1px solid rgba(255,255,255,0.08); }
    .kv { display:grid; grid-template-columns: 120px 1fr; gap:8px 10px; font-size:12px; opacity:0.9; margin-top:10px; }
    .kv div:nth-child(odd) { opacity:0.7; }
  </style>

  <!-- LOCAL NiiVue (no CDN) -->
  <script src="assets/vendor/niivue/niivue.min.js"></script>
</head>

<body>
<header>
  <div class="brand">
    <h1>Atlas Viewer (MNI + Desikan + 3D)</h1>
    <div class="sub">Local-only viewer • 3-plane + 3D render • mesh + atlas overlay</div>
  </div>
  <div class="actions">
    <a class="btn" href="/">Home</a>
    <button type="button" onclick="history.back()">Back</button>
  </div>
</header>

<main>
  <section class="panel">
    <h2>Controls</h2>

    <div class="row">
      <button id="btnLoadDefaults" type="button">Load template + atlas + mesh</button>
      <button id="btnClear" type="button">Clear</button>
    </div>

    <div class="row">
      <button id="mode2D" type="button">3-plane</button>
      <button id="mode3D" type="button">3D render</button>
      <button id="modeBoth" type="button">3-plane + 3D</button>
    </div>

    <label for="atlasOpacity">Atlas opacity</label>
    <input id="atlasOpacity" type="range" min="0" max="1" step="0.01" value="0.35" />

    <label for="userNifti">Optional: load your own NIfTI (underlay)</label>
    <input id="userNifti" type="file" accept=".nii,.nii.gz,application/gzip" />

    <div class="kv">
      <div>Status</div><div id="statusLine">Ready.</div>
      <div>Atlas label</div><div id="labelLine">—</div>
    </div>

    <p class="hint">
      The Desikan file you uploaded is a *label volume*. It’s an overlay.
      For a clean anatomical underlay, also add an MNI T1 (e.g., MNI152_T1_1mm_brain.nii.gz) later.
      This page will still run without it, but it’ll look less “MRI-like”.
    </p>

    <div id="status" class="status"></div>
  </section>

  <section>
    <canvas id="gl"></canvas>
  </section>
</main>

<script>
  // --- hard paths (match your repo) ---
  const PATHS = {
    // Optional underlay (if you add it later, this auto-uses it)
    t1Candidates: [
      "assets/neurop/MNI152_T1_1mm_brain.nii.gz",
      "assets/neurop/MNI152_T1_1mm.nii.gz",
      "images/mni152.nii.gz",
      "images/mni152.nii"
    ],
    atlas: "assets/neurop/MNI152_T1_1mm_desikan_adjusted.nii.gz",
    atlasLabelsTxt: "assets/neurop/MNI152_T1_1mm_desikan_adjusted.txt",
    mesh: "assets/neurop/mni152_2009.mz3"
  };

  const statusLine = document.getElementById("statusLine");
  const labelLine  = document.getElementById("labelLine");
  const statusBox  = document.getElementById("status");

  function setStatus(oneLine, detail="") {
    statusLine.textContent = oneLine;
    statusBox.textContent = detail;
  }

  // sanity check: Niivue is global
  if (typeof Niivue === "undefined") {
    setStatus("ERROR: NiiVue not loaded",
      "Check the script path:\nassets/vendor/niivue/niivue.min.js\n\nOpen it directly in the browser to confirm it serves (not 404).");
    throw new Error("Niivue not loaded");
  }

  const nv = new Niivue({
    backColor: [0,0,0,1],
    isColorbar: false,
    show3Dcrosshair: true
  });

  nv.attachTo("gl");
  nv.setSliceType(nv.sliceTypeMultiplanarRender);

  // --- label map parsing ---
  // Your txt is typically: integer<whitespace>LabelName
  const labelMap = new Map();
  async function loadLabelMap() {
    try {
      const r = await fetch(PATHS.atlasLabelsTxt, { cache: "no-store" });
      if (!r.ok) throw new Error(`HTTP ${r.status}`);
      const txt = await r.text();
      txt.split(/\r?\n/).forEach(line => {
        const s = line.trim();
        if (!s) return;
        const m = s.match(/^(\d+)\s+(.*)$/);
        if (!m) return;
        labelMap.set(parseInt(m[1], 10), m[2].trim());
      });
      setStatus("Label map loaded", `Loaded ${labelMap.size} atlas labels from:\n${PATHS.atlasLabelsTxt}`);
    } catch (e) {
      setStatus("Label map load failed", `Could not fetch:\n${PATHS.atlasLabelsTxt}\n\n${e.message || e}`);
    }
  }

  // --- loading helpers ---
  async function tryLoadUnderlay() {
    for (const p of PATHS.t1Candidates) {
      try {
        await nv.loadVolumes([{ url: p, name: "MNI_T1", opacity: 1.0 }]);
        return p;
      } catch (e) {}
    }
    return null;
  }

  async function loadAtlasOverlay(opacity=0.35) {
    // If underlay wasn't loaded, atlas becomes the first volume (still works, just uglier)
    await nv.addVolumeFromUrl({
      url: PATHS.atlas,
      name: "Desikan_Atlas",
      opacity: opacity,
      // label volumes look best with a discrete-ish LUT; NiiVue supports several built-ins
      colormap: "random",
      isNearestInterpolation: true
    });
  }

  async function loadMesh() {
    try {
      await nv.loadMeshes([{ url: PATHS.mesh, name: "mni152_2009" }]);
    } catch (e) {
      // mesh is optional; don't hard fail
      setStatus("Mesh load failed", `Could not load mesh:\n${PATHS.mesh}\n\n${e.message || e}`);
    }
  }

  async function loadDefaults() {
    labelLine.textContent = "—";
    setStatus("Loading…", "");

    // wipe clean
    try {
      nv.closeAllVolumes();
      nv.closeAllMeshes();
      nv.updateGLVolume();
    } catch {}

    const underlayPath = await tryLoadUnderlay();
    if (underlayPath) {
      setStatus("Underlay loaded", `Loaded underlay:\n${underlayPath}`);
    } else {
      setStatus("No underlay found", "No MNI T1 underlay found in the candidate paths.\nContinuing with atlas-only (still functional).");
    }

    try {
      await loadAtlasOverlay(parseFloat(document.getElementById("atlasOpacity").value));
      await loadMesh();
      nv.updateGLVolume();
      setStatus("Loaded", `Atlas:\n${PATHS.atlas}\nMesh:\n${PATHS.mesh}\n\nIf the screen is blank: open DevTools → Console and tell me the first error line.`);
    } catch (e) {
      setStatus("ERROR loading volumes", e.message || String(e));
      console.error(e);
    }
  }

  function clearAll() {
    try {
      nv.closeAllVolumes();
      nv.closeAllMeshes();
      nv.updateGLVolume();
      labelLine.textContent = "—";
      setStatus("Cleared", "");
    } catch (e) {
      setStatus("Clear failed", e.message || String(e));
    }
  }

  // --- basic atlas “label at crosshair” ---
  // NiiVue API differs by build/version; this is a best-effort implementation:
  function updateLabelReadoutBestEffort() {
    try {
      // find atlas volume by name
      const idx = (nv.volumes || []).findIndex(v => (v?.name || "").includes("Desikan_Atlas"));
      if (idx < 0) return;

      // Some builds expose values at crosshair via nv.getVolumeValue(idx) or similar.
      // We'll attempt a few common patterns without crashing.
      let val = null;

      if (typeof nv.getVolumeValue === "function") {
        val = nv.getVolumeValue(idx);
      } else if (typeof nv.getValue === "function") {
        val = nv.getValue(idx);
      } else if (nv.volumes[idx]?.getValueAtCrosshair) {
        val = nv.volumes[idx].getValueAtCrosshair();
      }

      if (val == null) return;

      const labelInt = Math.round(Number(val));
      const name = labelMap.get(labelInt) || `Label ${labelInt} (no name found)`;
      labelLine.textContent = name;
    } catch (e) {
      // silent: label readout is “nice to have”
    }
  }

  // --- UI wiring ---
  document.getElementById("btnLoadDefaults").addEventListener("click", loadDefaults);
  document.getElementById("btnClear").addEventListener("click", clearAll);

  document.getElementById("mode2D").addEventListener("click", () => {
    nv.setSliceType(nv.sliceTypeMultiplanar);
    nv.updateGLVolume();
    setStatus("Mode: 3-plane", "");
  });

  document.getElementById("mode3D").addEventListener("click", () => {
    nv.setSliceType(nv.sliceTypeRender);
    nv.updateGLVolume();
    setStatus("Mode: 3D render", "");
  });

  document.getElementById("modeBoth").addEventListener("click", () => {
    nv.setSliceType(nv.sliceTypeMultiplanarRender);
    nv.updateGLVolume();
    setStatus("Mode: 3-plane + 3D", "");
  });

  document.getElementById("atlasOpacity").addEventListener("input", (ev) => {
    const v = parseFloat(ev.target.value);
    const idx = (nv.volumes || []).findIndex(vol => (vol?.name || "").includes("Desikan_Atlas"));
    if (idx >= 0) {
      nv.volumes[idx].opacity = v;
      nv.updateGLVolume();
    }
  });

  document.getElementById("userNifti").addEventListener("change", async (ev) => {
    const f = ev.target.files?.[0];
    if (!f) return;

    setStatus("Loading your NIfTI…", f.name);
    try {
      // clear existing underlay volumes but keep atlas if already loaded
      // easiest: full clear then reload atlas; keeps behaviour consistent
      nv.closeAllVolumes();
      nv.closeAllMeshes();
      await nv.loadFromFile(f); // becomes underlay
      await loadAtlasOverlay(parseFloat(document.getElementById("atlasOpacity").value));
      await loadMesh();
      nv.updateGLVolume();
      setStatus("Loaded your NIfTI + atlas + mesh", "");
    } catch (e) {
      setStatus("ERROR loading your NIfTI", e.message || String(e));
      console.error(e);
    }
  });

  // Listen for interaction to update label readout (best effort)
  // Different builds expose different events; this is conservative.
  document.getElementById("gl").addEventListener("mouseup", updateLabelReadoutBestEffort);
  document.getElementById("gl").addEventListener("wheel", () => setTimeout(updateLabelReadoutBestEffort, 50));

  // start: load label map + defaults
  loadLabelMap().then(() => loadDefaults());
</script>
</body>
</html>
