<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />

  <title>Remy Cohan | MNI Atlas + Mesh Viewer | Neuropsis</title>
  <meta name="description" content="Local-only neuroimaging viewer by Remy Cohan (Neuropsis). Preloaded 3D brain mesh with optional atlas labels. Load your own NIfTI locally. Nothing uploads." />
  <meta name="keywords" content="Remy Cohan, Neuropsis, NIfTI viewer, neuroimaging, atlas viewer, 3D brain, mesh, TMS" />
  <meta name="author" content="Remy Cohan" />
  <link rel="canonical" href="https://www.neuropsis.org/tms_visualiser.html" />

  <meta property="og:title" content="Remy Cohan | MNI Atlas + Mesh Viewer" />
  <meta property="og:description" content="Local-only: preloaded 3D brain mesh + optional atlas labels. Load your own NIfTI. Nothing uploads." />
  <meta property="og:type" content="website" />
  <meta property="og:url" content="https://www.neuropsis.org/tms_visualiser.html" />

  <style>
    :root{
      --bg:#05070a;
      --panel:#0b1017;
      --line:#101827;
      --text:#e7eefc;
      --muted:#9fb0cb;
      --accent:#7aa2ff;
      --danger:#ff6b6b;
      --ok:#4be38a;
      --shadow:0 12px 40px rgba(0,0,0,.45);
      --radius:18px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
      background:
        radial-gradient(1200px 700px at 20% 0%, #0a1330 0%, rgba(10,19,48,0) 60%),
        radial-gradient(900px 600px at 85% 10%, #0a2a24 0%, rgba(10,42,36,0) 55%),
        var(--bg);
      color:var(--text);
    }

    .topbar{
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding:18px 22px;
      border-bottom:1px solid rgba(255,255,255,.06);
      background: linear-gradient(to bottom, rgba(0,0,0,.45), rgba(0,0,0,0));
      position:sticky;
      top:0;
      backdrop-filter: blur(10px);
      z-index: 50;
    }
    .brand{display:flex; flex-direction:column; gap:2px;}
    .brand h1{
      margin:0;
      font-size:18px;
      letter-spacing:.2px;
      display:flex;
      align-items:center;
      gap:10px;
    }
    .dot{
      width:10px;height:10px;border-radius:50%;
      background:#ff3b3b;
      box-shadow:0 0 0 4px rgba(255,59,59,.12);
      flex:0 0 auto;
    }
    .brand .sub{color:var(--muted); font-size:12.5px;}
    .navbtns{display:flex; gap:10px; align-items:center;}

    .btn{
      border:1px solid rgba(255,255,255,.10);
      background: rgba(16,24,39,.65);
      color:var(--text);
      padding:9px 12px;
      border-radius: 12px;
      cursor:pointer;
      font-weight:600;
      font-size:13px;
      transition:.15s ease;
      user-select:none;
    }
    .btn:hover{transform: translateY(-1px); border-color: rgba(122,162,255,.35)}
    .btn.ghost{background:transparent}
    .btn.primary{border-color: rgba(122,162,255,.35)}
    .statuspill{
      margin-left:10px;
      padding:7px 10px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.25);
      font-size:12.5px;
      color:var(--muted);
      white-space:nowrap;
    }

    .wrap{
      display:grid;
      grid-template-columns: 360px 1fr;
      gap:18px;
      padding:18px;
      max-width: 1500px;
      margin:0 auto;
    }
    .panel{
      background: linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.02));
      border:1px solid rgba(255,255,255,.08);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
    }
    .controls{padding:16px;}
    .controls h2{
      margin:0 0 10px;
      font-size:14px;
      color:var(--muted);
      font-weight:700;
      letter-spacing:.2px;
    }
    .row{display:flex; gap:10px; flex-wrap:wrap; align-items:center;}
    .spacer{height:14px}
    label{font-size:12.5px; color:var(--muted)}
    input[type="range"]{width:100%}
    input[type="file"]{width:100%; color:var(--muted)}
    .kv{font-size:12.5px; color:var(--muted); line-height:1.45;}
    .kv .bad{color:var(--danger); font-weight:700}
    .kv .ok{color:var(--ok); font-weight:700}
    .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;}

    .viewer{
      padding:10px;
      display:flex;
      flex-direction:column;
      min-height: 720px;
    }
    #glwrap{
      position:relative;
      flex:1;
      border-radius: calc(var(--radius) - 6px);
      overflow:hidden;
      border:1px solid rgba(255,255,255,.08);
      background: #000;
    }
    canvas{display:block; width:100%; height:100%}
    .overlayBottom{
      display:flex;
      justify-content:space-between;
      gap:12px;
      padding:10px 12px 12px;
      color:var(--muted);
      font-size:12.5px;
    }
  </style>

  <!-- Load local UMD (your repo). We also do a JS fallback if it initialises weirdly. -->
  <script src="/assets/vendor/niivue/niivue.umd.js?v=0.66.0"></script>
</head>

<body>
  <header class="topbar">
    <div class="brand">
      <h1><span class="dot"></span>MNI Atlas + Mesh Viewer</h1>
      <div class="sub">Remy Cohan • Neuropsis • local-only • 3-plane / 3D / 4-panel</div>
    </div>
    <div class="navbtns">
      <button class="btn" id="homeBtn">Home</button>
      <button class="btn ghost" id="backBtn">Back</button>
      <span class="statuspill" id="pill">Starting…</span>
    </div>
  </header>

  <main class="wrap">
    <section class="panel controls">
      <h2>Controls</h2>

      <div class="row">
        <button class="btn primary" id="addAtlasBtn">Add atlas labels</button>
        <button class="btn ghost" id="clearBtn">Clear</button>
      </div>

      <div class="spacer"></div>

      <div class="row">
        <button class="btn ghost" id="mode2dBtn">3-plane</button>
        <button class="btn ghost" id="mode3dBtn">3D</button>
        <button class="btn" id="mode4Btn">4-panel</button>
      </div>

      <div class="spacer"></div>

      <label for="opacity">Atlas opacity</label>
      <input id="opacity" type="range" min="0" max="1" step="0.01" value="0.45" />

      <div class="spacer"></div>

      <label>Load your own NIfTI (.nii / .nii.gz)</label>
      <input id="userNifti" type="file" accept=".nii,.nii.gz" />

      <div class="spacer"></div>

      <div class="row">
        <button class="btn" id="loadUserBtn">Clear + load my NIfTI</button>
        <button class="btn ghost" id="skullBtn">Skull-ish render</button>
      </div>

      <div class="spacer"></div>

      <div class="kv">
        <div><b>Status</b></div>
        <div id="statusLine" class="mono">—</div>
        <div class="spacer"></div>
        <div><b>Label</b></div>
        <div id="labelLine" class="mono">—</div>
        <div class="spacer"></div>
        <div class="small">
          Runs entirely in your browser. Nothing uploads.
        </div>
      </div>
    </section>

    <section class="panel viewer">
      <div id="glwrap">
        <canvas id="gl"></canvas>
      </div>
      <div class="overlayBottom">
        <div id="coord" class="mono">x y z: —</div>
        <div class="mono">Scroll: zoom • Drag: pan • Right-drag: window/level</div>
      </div>
    </section>
  </main>

  <script>
    // -----------------------------
    // Paths (repo local)
    // -----------------------------
    const PATHS = {
      atlasNii:  '/assets/neurop/MNI152_T1_1mm_desikan_adjusted.nii.gz',
      atlasTxt:  '/assets/neurop/MNI152_T1_1mm_desikan_adjusted.txt',
      meshMz3:   '/assets/neurop/mni152_2009.mz3',
      // CDN fallback if the global initialiser is flaky (rare, but you’ve seen it):
      cdnUmdMin: 'https://cdn.jsdelivr.net/npm/@niivue/niivue@0.66.0/dist/niivue.umd.min.js'
    };

    const ui = {
      pill: document.getElementById('pill'),
      status: document.getElementById('statusLine'),
      label: document.getElementById('labelLine'),
      coord: document.getElementById('coord'),
      opacity: document.getElementById('opacity'),
      userNifti: document.getElementById('userNifti'),
      loadUserBtn: document.getElementById('loadUserBtn'),
      skullBtn: document.getElementById('skullBtn'),
      addAtlasBtn: document.getElementById('addAtlasBtn'),
      clearBtn: document.getElementById('clearBtn'),
      mode2dBtn: document.getElementById('mode2dBtn'),
      mode3dBtn: document.getElementById('mode3dBtn'),
      mode4Btn: document.getElementById('mode4Btn'),
      homeBtn: document.getElementById('homeBtn'),
      backBtn: document.getElementById('backBtn'),
    };

    function setPill(t){ ui.pill.textContent = t; }
    function setStatus(t, isError=false){
      ui.status.innerHTML = isError ? `<span class="bad">${t}</span>` : t;
    }

    // -----------------------------
    // Find the constructor reliably (UMD builds vary)
    // The one you’re serving typically exposes: window.niivue.Niivue
    // -----------------------------
    function getNiivueCtor() {
      if (window.niivue && typeof window.niivue.Niivue === 'function') return window.niivue.Niivue;
      if (window.niivue && typeof window.niivue === 'function') return window.niivue;
      if (window.Niivue && typeof window.Niivue.Niivue === 'function') return window.Niivue.Niivue;
      if (typeof window.Niivue === 'function') return window.Niivue;
      return null;
    }

    async function ensureNiivueLoaded() {
      let ctor = getNiivueCtor();
      if (ctor) return ctor;

      // Fallback: inject CDN UMD min
      await new Promise((resolve, reject) => {
        const s = document.createElement('script');
        s.src = PATHS.cdnUmdMin;
        s.onload = resolve;
        s.onerror = reject;
        document.head.appendChild(s);
      });

      ctor = getNiivueCtor();
      return ctor;
    }

    // -----------------------------
    // NiiVue state
    // -----------------------------
    let nv = null;
    let atlasVolIndex = null;   // overlay index, once added
    let labelsLoaded = false;

    const atlasMap = new Map(); // id -> label

    async function loadAtlasLabelsTxt() {
      const res = await fetch(PATHS.atlasTxt, { cache:'no-store' });
      if (!res.ok) throw new Error('Atlas label file not found.');
      const txt = await res.text();
      atlasMap.clear();

      for (const line of txt.split(/\r?\n/)) {
        const s = line.trim();
        if (!s) continue;
        const m = s.match(/^(\d+)[\s,;:\t]+(.+)$/);
        if (!m) continue;
        const id = parseInt(m[1], 10);
        const label = m[2].trim();
        if (!Number.isNaN(id) && label) atlasMap.set(id, label);
      }
      labelsLoaded = true;
    }

    function attachLocationListener() {
      if (!nv) return;

      const handler = (loc) => {
        const mm = loc?.mm || loc?.mmXYZ || loc?.xyzMM || null;
        if (mm && mm.length >= 3) {
          ui.coord.textContent = `x y z: ${mm[0].toFixed(1)} ${mm[1].toFixed(1)} ${mm[2].toFixed(1)}`;
        }

        // Try to extract atlas value at cursor
        let val = null;
        if (typeof loc?.value === 'number') val = loc.value;
        if (Array.isArray(loc?.values) && atlasVolIndex != null && typeof loc.values[atlasVolIndex] === 'number') {
          val = loc.values[atlasVolIndex];
        }

        if (val == null) {
          try {
            const v = nv.getValueUnderMouse?.();
            if (typeof v === 'number') val = v;
          } catch(e) {}
        }

        if (val == null || atlasVolIndex == null) {
          ui.label.textContent = '—';
          return;
        }

        const id = Math.round(val);
        if (!id) {
          ui.label.textContent = '—';
          return;
        }
        const label = atlasMap.get(id) || `Label ${id}`;
        ui.label.textContent = label;
      };

      // Most builds accept nv.onLocationChange
      try { nv.onLocationChange = handler; } catch(e) {}
      try { if (nv.opts) nv.opts.onLocationChange = handler; } catch(e) {}
    }

    // -----------------------------
    // Modes (sliceType differs by version; these are best-effort)
    // -----------------------------
    function setMode(mode) {
      if (!nv) return;

      // Known-ish patterns:
      // - multi-planar: 0
      // - render: 4
      // - multi + render: 2  (often the “4-panel” feel in one canvas)
      const st = (mode === '2d') ? 0 : (mode === '3d') ? 4 : 2;

      try { nv.setSliceType?.(st); } catch(e) {}
      setPill(mode === '2d' ? '3-plane' : mode === '3d' ? '3D' : '4-panel');
    }

    function setAtlasOpacity(v) {
      if (!nv || atlasVolIndex == null) return;
      const opacity = parseFloat(v);

      try { nv.setOpacity?.(atlasVolIndex, opacity); } catch(e) {}
      try {
        const vol = nv.volumes?.[atlasVolIndex];
        if (vol) vol.opacity = opacity;
        nv.updateGLVolume?.();
      } catch(e) {}
    }

    // -----------------------------
    // Core actions
    // -----------------------------
    async function init() {
      setPill('Starting…');
      setStatus('Initialising…');

      const Ctor = await ensureNiivueLoaded();
      if (!Ctor) {
        setPill('Error');
        setStatus('ERROR: NiiVue initialised but constructor not found. Use the UMD build.', true);
        return;
      }

      nv = new Ctor({ isResizeCanvas: true, logLevel: 'error' });
      nv.attachToCanvas(document.getElementById('gl'));

      attachLocationListener();

      // Start in “wow” mode: mesh + 4-panel layout (if supported)
      setMode('4d'); // internally maps to 2
      await preloadMeshOnly();

      setPill('Ready');
      setStatus('Ready.');
    }

    async function preloadMeshOnly() {
      if (!nv) return;

      setPill('Loading…');
      setStatus('Loading brain mesh…');

      try {
        nv.closeAll?.(); // clears volumes + meshes
      } catch(e) {}

      atlasVolIndex = null;
      ui.label.textContent = '—';

      // Load mesh first (your “default demo”)
      try {
        await nv.loadMeshes?.([{ url: PATHS.meshMz3, name:'MNI mesh', opacity: 0.55 }]);
      } catch(e) {
        // Some builds need at least one volume to initialise GL state cleanly.
        // If mesh-only fails, we keep going and you still have user NIfTI mode.
        console.warn('Mesh-only load failed:', e);
      }

      try { nv.updateGLVolume?.(); } catch(e) {}
      setPill('Ready');
      setStatus('Ready.');
    }

    async function addAtlasOverlay() {
      if (!nv) return;

      setPill('Loading…');
      setStatus('Adding atlas labels…');

      try {
        if (!labelsLoaded) await loadAtlasLabelsTxt();
      } catch(e) {
        console.warn(e);
        // Don’t hard fail; labels might still show ids.
      }

      try {
        // If already added, just toggle opacity up
        if (atlasVolIndex != null) {
          setAtlasOpacity(ui.opacity.value);
          setPill('Ready');
          setStatus('Atlas already added.');
          return;
        }

        // Add label volume overlay
        // Different versions support either addVolumeFromUrl OR loadVolumes
        const overlay = {
          url: PATHS.atlasNii,
          name: 'Atlas',
          opacity: parseFloat(ui.opacity.value),
          colormap: 'glasbey',
          isLabel: true
        };

        if (nv.addVolumeFromUrl) {
          await nv.addVolumeFromUrl(overlay);
        } else if (nv.loadVolumes) {
          // If no volumes yet, loadVolumes will create the volume stack.
          await nv.loadVolumes([overlay]);
        } else {
          throw new Error('This NiiVue build does not support loading volumes.');
        }

        atlasVolIndex = (nv.volumes?.length ?? 1) - 1;

        try { nv.updateGLVolume?.(); } catch(e) {}
        attachLocationListener();

        setPill('Ready');
        setStatus('Atlas added. Click on the brain to see labels.');
      } catch(e) {
        console.error(e);
        setPill('Error');
        setStatus('ERROR adding atlas. Check DevTools Console.', true);
      }
    }

    async function clearAll() {
      if (!nv) return;
      try { nv.closeAll?.(); } catch(e) {}
      atlasVolIndex = null;
      ui.coord.textContent = 'x y z: —';
      ui.label.textContent = '—';
      setPill('Ready');
      setStatus('Cleared.');
    }

    async function clearAndLoadUserNifti() {
      if (!nv) return;
      const f = ui.userNifti.files?.[0];
      if (!f) {
        setStatus('Pick a NIfTI first.', true);
        return;
      }

      setPill('Loading…');
      setStatus('Loading your NIfTI…');

      try {
        nv.closeAll?.();
      } catch(e) {}

      atlasVolIndex = null;
      ui.label.textContent = '—';

      try {
        if (nv.addVolumeFromFile) {
          await nv.addVolumeFromFile(f);
        } else {
          // Blob URL fallback
          const buf = await f.arrayBuffer();
          const blobUrl = URL.createObjectURL(new Blob([buf]));
          await nv.loadVolumes([{ url: blobUrl, name: f.name, opacity: 1.0, colormap: 'gray' }]);
        }

        attachLocationListener();
        setMode('4d'); // 4-panel feel
        setPill('Ready');
        setStatus('Loaded. (Still local-only.)');
      } catch(e) {
        console.error(e);
        setPill('Error');
        setStatus('ERROR loading NIfTI. Check DevTools Console.', true);
      }
    }

    function skullishRenderToggle() {
      if (!nv) return;

      // Best-effort across versions:
      // 1) Switch to 3D render
      // 2) Turn on volume rendering if available
      setMode('3d');

      try { nv.setVolumeRendering?.(true); } catch(e) {}
      try { nv.setRenderAzimuthElevation?.(120, 15); } catch(e) {}
      try { nv.updateGLVolume?.(); } catch(e) {}

      setStatus('3D render mode. (Skull effect depends on your image and NiiVue build.)');
    }

    // -----------------------------
    // UI wiring
    // -----------------------------
    ui.homeBtn.addEventListener('click', () => window.location.href = '/');
    ui.backBtn.addEventListener('click', () => history.back());

    ui.addAtlasBtn.addEventListener('click', addAtlasOverlay);
    ui.clearBtn.addEventListener('click', clearAll);

    ui.opacity.addEventListener('input', (e) => setAtlasOpacity(e.target.value));

    ui.mode2dBtn.addEventListener('click', () => setMode('2d'));
    ui.mode3dBtn.addEventListener('click', () => setMode('3d'));
    ui.mode4Btn.addEventListener('click', () => setMode('4d'));

    ui.loadUserBtn.addEventListener('click', clearAndLoadUserNifti);
    ui.skullBtn.addEventListener('click', skullishRenderToggle);

    // -----------------------------
    // Boot: preload mesh immediately
    // -----------------------------
    (function boot(){
      init().catch(err => {
        console.error(err);
        setPill('Error');
        setStatus('ERROR: initialisation failed. Check DevTools Console.', true);
      });
    })();
  </script>
</body>
</html>
